# 8. 단위 테스트와 리펙토링

## 책의 내용

* 애자일 소프트웨어 개발 방법론에서 자동화된 테스트가 중요한 이유
* 단위 테스트가 코드 풀질에 대한 거울이 되는 이유
* 자동화된 테스트와 품질 게이트를 설정하기 위한 프레임워크와 도구
* 단위 테스트가 문서화와 도메인의 깊은 이해에 도움을 주는 이유
* TDD의 개념(테스트 주도 개발 방법론)

## 1. 디자인 원칙과 단위 테스트

단위 테스트   : 다른 코드의 일부분이 유효한지 검사하는 코드 
저자의 주장 : 단위 테스트는 소프트웨어의 핵심이 되는 필수적인 기능으로 일반 비즈니스로직과 동일한 수준으로 다루어야 한다.

##### 단위 테스트의 특징
* 격리
  * 외부 에이전트에 의존하지 않고 **독립**적으로 구동할 수 있어야 한다.
  * **로직의 검증**에만 집중해야 한다.
  * 데이터베이스와 연결하지 않아야 한다.
  * HTTP 요청은 하지말아야 한다.
  * 단위 테스트가 **임의의 순서**로 일어나더라도 성공해야 한다.
* 성능
  * 신속하게 실행될 수 있어야 한다.(너무 오래 걸리면 안된다)
  * 반복적으로 여러번 수행될 수 있어야 한다.
* 자체 검증 
  * 단위 테스트의 실행만으로 결과를 결정할 수 있어야 한다.
  * 단위 테스트를 처리하기 위한 추가 단계가 없어야 한다.(?)

### 1.1 자동화된 테스트의 다른 형태

* 단위 테스트
  * 함수나 메쏘드 단위의 작은 단위를 테스트함
  * 최대한 자세하게 검사
  * 적절한 바운드리 설계가 중요
* 클래스 테스트
  * 단위 테스트를 모은 테스트 스위트(suit)를 사용
  * 작은 단위테스트들의 집합
  * 코드 수정이 발생할 때마다 수행함
* 인수 테스트 (acceptance)
  * 유스케이스를 활용
  * 사용자 관점에서 테스트
  * 시스템의 유효성을 검사함
* 통합 테스트 (integration)
  * 여러 컴포넌트를 한번에 테스트
  * 격리를 고려하지 않아도 됨
  * HTTP 요청과 데이터베이스를 사용해도 상관없음(오히려 바람직)
  * 실용성이 있다면, 테스트를 위한 데이터베이스를 준비할 경우 도커 컨테이너를 활용하는 것도 바람직

### 1.2 단위 테스트와 애자일 소프트웨어 개발

* 신속하고 지속적인 가치를 제공하는 소프트웨어
* 빠른 피드백이 중요
* 소프트웨어의 유연성과 확장가능성이 필요함
* 좋은 디자인과 좋은 코드(SOLID 원칙을 잘 지킨 코드) 만으로는 변경에 유연하다는 것을 보장할 수 없음
* 단위테스트는 코드가 기대한 대로 돌아간다는 것을 보증할 수 있는 안전망임

###[1.3 단위 테스트와 소프트웨어 디자인](./metrics/README.md)

### 1.4 경계 테스트 

* 테스트의 범위는 우리가 작성한 코드의 범위로 한정해야 한다. (라이브러리 테스트는 우리의 책임이 아니다)
* 의존성은 호출이 적절한지 여부만 체크해도 충분하다.
* 좋은 소프트웨어는 책임소재가 명확하기 때문에 테스트 해야 할 범위도 명확하다.
* 좋은 단위 테스트는 시스템의 경계에는 패치(Mock)를 적용하여 넘어가고 핵심 기능에 초점을 둔다.


## 2. 프레임워크와 도구


### 2.1 테스트 프레임워크
* 테스트 프레임워크는 크게 두가지가 있다.
  * [unittest](https://docs.python.org/3/library/unittest.html)
    * 단순한 테스트 케이스 구현 가능
    * 다양한 테스트 핼퍼 기능들 제공 (assert)
  * [pytest](https://docs.pytest.org/en/latest/)
    * 의존성이 있는 코드를 테스트 할 경우 fixture 라는 패치 객체가 필요 
    * 복잡한 옵션이 추가로 필요한 경우 pytest를 사용해야 함.
* Source Code Merge Request 코드를 통해 두가지 버전으로 테스트 해보자.

``` python
# 한명이라도 변경 내용에 반대하는 경우 merge 요청이 거절된다.
# 아무도 반대하지 않고, 두명 이상의 개발자가 동의하면 merge 요청이 승인된다.
# 그 밖의 상태는 보류(pending) 된다.
```


#### unittest



``` python
예외가 발생하는지 뿐만 아니라 오류 메시지도 확인하자. 
발생한 예외가 정확히 우리가 원했던 예외인지 확인해야 한다.
우연히 예상했던 것과 다른 이유로 같은 오류가 발생할 수도 있다.
```

#### 테스트 파라미터화



#### pytest


### 2.2 코드 Coverage


### 2.3 Mock 객체

#### 패치와 모의에 대한 주의 사항

#### Mock 객체 사용하기

##### Mock 객체의 종류





## 3. 리팩토링

리펙토링을 하는 이유
* 코드의 구조 개선  -> 추가될 수 있는 요구사항에 유연하게 대응하기 위해
* 코드의 가독성 높이기 -> 유지보수성 비용 감소
  
수정 전과 후에도 동일하게 동작해야 하기 때문에 성공적인 리팩토링을 보장하기 위해 단위테스트가 반드시 필요함.

### 3.1 코드의 진화

### 3.2 상용 코드만 진화하는 것은 아니다?


## 4. 단위 테스트에 대한 추가 논의

### 4.1 속성 기반 테스트

### 4.2 변형 테스트


## 5. TDD